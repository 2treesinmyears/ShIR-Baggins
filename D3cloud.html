<!DOCTYPE html>
<html>
<head>
<title>D3 cloud</title>

<script type="text/javascript"
	src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript" id="brown">
	window.onload = function() {
		var count = Math.random() * 200 + 1;
		var dataset = [];
		var speedset = [];
		var speedAbs = [];

		var $window = $(window);
		var maxwidth = $window.width();
		var maxheight = $window.height();
		var colorLock = {}, movementLock = {};
		var mousePos = {};
		var justBounced = [];
		for (var i = 0; i <= count; i++) {
			var coord = [ Math.round(Math.random() * maxwidth),
					Math.round(Math.random() * maxheight) ];
			var speed = [ Math.round(Math.random() * 10),
					Math.round(Math.random() * 10) ];

			dataset.push(coord);
			speedset.push(speed);
			speedAbs.push(getSpeedAbs(speed))
			var b = [];
			for (var j = 0; j <= count; j++) {
				b.push(0);
			}
			justBounced.push(b);
		}

		var mouse = {
			isInside : true,
			coord : []
		};

		var body = d3.select('body');
		body.style("background", "black").style({
			position : 'absolute',
			bottom : 0,
			right : 0,
			top : 0,
			left : 0,
		});

		var cloud = body.append("svg").style({
			height : '100%',
			width : '100%',
		});

		var rect = cloud.append("rect").attr("width", "100%").attr("height",
				"100%").attr("opacity", "0").on("mousemove", function() {
			mouse.isInside = true;
			mouse.coord = d3.mouse(this);
		}).on("mouseout", function() {
			mouse.isInside = false;
		}).on("mouseenter", function() {
			mouse.isInside = true;
		}).on("mouseover", function() {
			mouse.isInside = true;
		});

		var circles = cloud.selectAll("circle").data(dataset);
		var radius = 5;
		circles.enter().append("circle").attr("cy", function(d) {
			return d[1] + "px";
		}).attr("cx", function(d) {
			return d[0] + "px";
		}).attr("r", radius).attr("fill", "red").call(beginMovement, dataset,
				speedset, speedAbs, $window, radius, justBounced, 50);

		cloud.selectAll("circle").call(beginColorTransition, 3000);

		function beginColorTransition(circles, duration) {

			d3.select(colorLock).transition().duration(duration).tween(
					"attr:fill", function() {
						var i = interpolateRgbSquare('red', 'yellow');
						return function(t) {
							circles.attr("fill", i(t));
						};
					}).transition().tween("attr:fill", function() {
				var i = interpolateRgbSquare('yellow', 'red');
				return function(t) {
					circles.attr("fill", i(t));
				};
			});
			setTimeout(function() {
				beginColorTransition(circles, duration);
			}, 2 * duration);
		}
		;

		function beginMovement(circles, dataset, speedset, speedAbs, window, R, justBounced,
				timeout) {
			var vx, vy, va;

			var maxwidth = window.width();
			var maxheight = window.height();
			var N = dataset.length;

			var change = [];// oldX, oldY, newX, newY

			for (var i = 0; i < N; i++) {
				var ch = [ dataset[i][0], dataset[i][1] ];
				dataset[i][0] += speedset[i][0];
				dataset[i][1] += speedset[i][1];
				ch.push(dataset[i][0]);
				ch.push(dataset[i][1]);
				change.push(ch);
			}
			var minD2 = 4 * R * R;
			for (var i = 0; i < N - 1; i++) {
				for (var j = i + 1; j < N; j++) {
					var newDist = getSqDistance(dataset[i][0], dataset[i][1], dataset[j][0], dataset[j][1]);
					if ( newDist < minD2 && justBounced[i][j] == 0) {
						vx = speedset[i][0];
						vy = speedset[i][1];
						va = speedAbs[i];
						speedset[i][0] = speedset[j][0];
						speedset[i][1] = speedset[j][1];
						speedAbs[i] = speedAbs[j];
						
						speedset[j][0] = vx;
						speedset[j][1] = vy;
						speedAbs[j] = va;
						
						justBounced[i][j] = 1;
						justBounced[j][i] = 1;
					} else {
						justBounced[i][j] = 0;
						justBounced[j][i] = 0;
					}
				}
			}

			for (var i = 0; i < N; i++) {
				if (dataset[i][0] < 2 * R)
					speedset[i][0] = Math.abs(speedset[i][0]);
				else if (dataset[i][0] > maxwidth - 2 * R)
					speedset[i][0] = -Math.abs(speedset[i][0]);
				if (dataset[i][1] < 2 * R)
					speedset[i][1] = Math.abs(speedset[i][1]);
				else if (dataset[i][1] > maxheight - 2 * R)
					speedset[i][1] = -Math.abs(speedset[i][1]);
			}
			var radius = 150, mn = 70;

			if (mouse.isInside && mouse.coord.length != 0) {
				var mouseX = mouse.coord[0];
				var mouseY = mouse.coord[1];
				for (var i = 0; i < N; i++) {
					var dist = Math.sqrt(getSqDistance(dataset[i][0],dataset[i][1],mouseX, mouseY));
					if (dist < radius) {
						var speed = speedset[i];
						var mousespeed = [
								Math.round(mn * (dataset[i][0] - mouseX)
										/ (dist + 1)),
								Math.round(mn * (dataset[i][1] - mouseY)
										/ (dist + 1)) ];
						var newSpeed = [speed[0]+ mousespeed[0], speed[1]+ mousespeed[1]];

						var mouseSpeedAbs = getSpeedAbs(newSpeed);
						
						speedset[i][0] = newSpeed [0] * speedAbs[i]
								/ mouseSpeedAbs;
						speedset[i][1] = newSpeed [1] * speedAbs[i]
								/ mouseSpeedAbs;
					}
				}
			}

			d3.select(movementLock).datum(change).transition().ease("linear")
					.duration(timeout).tween("attr:cy", function(d, j) {
						var i = [];
						for (var j = 0; j < N; j++) {
							i.push(d3.interpolateNumber(d[j][1], d[j][3]));
						}
						return function(t) {
							circles.each(function(p, k) {
								d3.select(this).attr("cy", (i[k])(t) + "px");
							});
						};
					}).tween("attr:cx", function(d, j) {
						var i = [];
						for (var j = 0; j < N; j++) {
							i.push(d3.interpolateNumber(d[j][0], d[j][2]));
						}
						return function(t) {
							circles.each(function(p, k) {
								d3.select(this).attr("cx", (i[k])(t) + "px");
							});
						};
					});

			setTimeout(function() {
				beginMovement(circles, dataset, speedset, speedAbs, window,
						R, justBounced, timeout);
			}, timeout);

		}
		;
	}
	function getSqDistance(x1, y1, x2, y2) {
		return ((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));
	}

	function getSpeedAbs(speed) {
		return Math.sqrt(speed[0] * speed[0] + speed[1] * speed[1]);
	}

	function d3_rgb_hex(v) {
		return v < 16 ? "0" + Math.max(0, v).toString(16) : Math.min(255, v)
				.toString(16);
	}
	function interpolateRgbSquare(a, b) {
		a = d3.rgb(a);
		b = d3.rgb(b);
		var ar = a.r, ag = a.g, ab = a.b, br = b.r - ar, bg = b.g - ag, bb = b.b
				- ab;

		return function(t) {
			var result = "#" + d3_rgb_hex(Math.round(ar + br * t * t))
					+ d3_rgb_hex(Math.round(ag + bg * t * t))
					+ d3_rgb_hex(Math.round(ab + bb * t * t));
			return result;
		};
	}
</script>
</head>
<body>

</body>
</html>
